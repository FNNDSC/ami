<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: parsers/parsers.nrrd.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: parsers/parsers.nrrd.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// use nifti-js and just parse header.???

// Slicer way to handle images
// should follow it...
 // 897   if ( (this->IndexSeriesInstanceUIDs[k] != idxSeriesInstanceUID &amp;&amp; this->IndexSeriesInstanceUIDs[k] >= 0 &amp;&amp; idxSeriesInstanceUID >= 0) ||
 // 898        (this->IndexContentTime[k] != idxContentTime &amp;&amp; this->IndexContentTime[k] >= 0 &amp;&amp; idxContentTime >= 0) ||
 // 899        (this->IndexTriggerTime[k] != idxTriggerTime &amp;&amp; this->IndexTriggerTime[k] >= 0 &amp;&amp; idxTriggerTime >= 0) ||
 // 900        (this->IndexEchoNumbers[k] != idxEchoNumbers &amp;&amp; this->IndexEchoNumbers[k] >= 0 &amp;&amp; idxEchoNumbers >= 0) ||
 // 901        (this->IndexDiffusionGradientOrientation[k] != idxDiffusionGradientOrientation  &amp;&amp; this->IndexDiffusionGradientOrientation[k] >= 0 &amp;&amp; idxDiffusionGradientOrientation >= 0) ||
 // 902        (this->IndexSliceLocation[k] != idxSliceLocation &amp;&amp; this->IndexSliceLocation[k] >= 0 &amp;&amp; idxSliceLocation >= 0) ||
 // 903        (this->IndexImageOrientationPatient[k] != idxImageOrientationPatient &amp;&amp; this->IndexImageOrientationPatient[k] >= 0 &amp;&amp; idxImageOrientationPatient >= 0) )
 // 904     {
 // 905       continue;
 // 906     }

//http://brainder.org/2012/09/23/the-nifti-file-format/

/*** Imports ***/
import ParsersVolume from './parsers.volume';

let pako = require('pako');
let NrrdReader = require('nrrd-js');
/**
 * @module parsers/nifti
 */
export default class ParsersNifti extends ParsersVolume {
  constructor(data, id) {

    super();
    
    /**
      * @member
      * @type {arraybuffer}
    */
    this._id = id;
    this._arrayBuffer = data.buffer;
    this._url = data.url;
    this._dataSet = null;
    this._unpackedData = null;

    try{
      this._dataSet = NrrdReader.parse(this._arrayBuffer);
    }
    catch(error){
      window.console.log('ooops... :(');
    }

    window.console.log(this._dataSet);
  }

  rightHanded(){

    if( this._dataSet.space.match(/^right-anterior-superior/) ||
        this._dataSet.space.match(/^left-posterior-superior/) ) {

     this._rightHanded = true;

    } else {

      this._rightHanded = false;

    }

    return this._rightHanded;

  }

  seriesInstanceUID() {
    // use filename + timestamp..?
    return this._url;
  }

  numberOfFrames() {
    return this._dataSet.sizes[2];
  }

  numberOfChannels() {
    let numberOfChannels = 1;
    return numberOfChannels;
  }

  sopInstanceUID(frameIndex = 0) {
    return frameIndex;
  }

  rows(frameIndex = 0) {
    return this._dataSet.sizes[1];
  }

  columns(frameIndex = 0) {
    return this._dataSet.sizes[0];
  }

  pixelType(frameIndex = 0) {
    // 0 - int
    // 1 - float
    let pixelType = 0;
    if(this._dataSet.type === 'float'){
      pixelType = 1;
    }
    return pixelType;
  }

  bitsAllocated(frameIndex = 0) {
    let bitsAllocated = 1;

    if(this._dataSet.type === 'int8' ||
       this._dataSet.type === 'uint8' ||
       this._dataSet.type === 'char'){
      bitsAllocated = 8;
    }
    else if(this._dataSet.type === 'int16' ||
      this._dataSet.type === 'uint16' ||
      this._dataSet.type === 'short'){
      bitsAllocated = 16;
    }
    else if(this._dataSet.type === 'int32' ||
      this._dataSet.type === 'uint32' ||
      this._dataSet.type === 'float'){
      bitsAllocated = 32;
    }

    return bitsAllocated;
  }

  pixelSpacing(frameIndex = 0) {
    let x = new THREE.Vector3(
      this._dataSet.spaceDirections[0][0],
      this._dataSet.spaceDirections[0][1],
      this._dataSet.spaceDirections[0][2]);

    let y = new THREE.Vector3(
      this._dataSet.spaceDirections[1][0],
      this._dataSet.spaceDirections[1][1],
      this._dataSet.spaceDirections[1][2]);

    let z = new THREE.Vector3(
      this._dataSet.spaceDirections[2][0],
      this._dataSet.spaceDirections[2][1],
      this._dataSet.spaceDirections[2][2]);

    return [x.length(), y.length(), z.length()];
  }

  sliceThickness() {
    // should be a string...
    return null;//this._dataSet.pixDims[3].toString();
  }

  imageOrientation(frameIndex = 0) {

    let invertX = this._dataSet.space.match(/right/) ? -1 : 1;
    let invertY = this._dataSet.space.match(/anterior/) ? -1 : 1;

    let x = new THREE.Vector3(
      this._dataSet.spaceDirections[0][0] * invertX,
      this._dataSet.spaceDirections[0][1] * invertY,
      this._dataSet.spaceDirections[0][2]);
    x.normalize();

    let y = new THREE.Vector3(
      this._dataSet.spaceDirections[1][0] * invertX,
      this._dataSet.spaceDirections[1][1] * invertY,
      this._dataSet.spaceDirections[1][2]);
    y.normalize();

    return [
      x.x, x.y, x.z,
      y.x, y.y, y.z
      ];
  }

  imagePosition(frameIndex = 0) {
    return [
      this._dataSet.spaceOrigin[0],
      this._dataSet.spaceOrigin[1],
      this._dataSet.spaceOrigin[2]
    ];
  }

  dimensionIndexValues(frameIndex = 0) {
    return null;
  }

  instanceNumber(frameIndex = 0) {
    return frameIndex;
  }

  windowCenter(frameIndex = 0) {
    // calc min and calc max
    return null;
  }

  windowWidth(frameIndex = 0) {
    // calc min and calc max
    return null;
  }

  rescaleSlope(frameIndex = 0) {
    return 1;//this._dataSet.scl_slope;
  }

  rescaleIntercept(frameIndex = 0) {
    return 0;//this._dataSet.scl_intercept;
  }

  minMaxPixelData(pixelData = []) {
    let minMax = [65535, -32768];
    let numPixels = pixelData.length;
    for (let index = 0; index &lt; numPixels; index++) {
      let spv = pixelData[index];
      minMax[0] = Math.min(minMax[0], spv);
      minMax[1] = Math.max(minMax[1], spv);
    }

    return minMax;
  }

  extractPixelData(frameIndex = 0) {
    return this._decompressUncompressed(frameIndex);
  }

  _decompressUncompressed(frameIndex = 0) {
    let buffer = this._dataSet.buffer;
    let numberOfChannels = this.numberOfChannels();
    let numPixels = this.rows(frameIndex) * this.columns(frameIndex) * numberOfChannels;
    if( !this.rightHanded() ){
      frameIndex = this.numberOfFrames() - 1 - frameIndex; 
    }
    let frameOffset = frameIndex * numPixels;

    // unpack data if needed
    if (this._unpackedData === null &amp;&amp;
      this._dataSet.encoding === 'gzip') {
      let unpackedData = pako.inflate(this._dataSet.buffer);
      this._unpackedData = unpackedData.buffer;
      buffer = this._unpackedData;
    }
    else if(this._dataSet.encoding === 'gzip'){
      buffer = this._unpackedData;
    }

    if(this._dataSet.type === 'int8' ||
       this._dataSet.type === 'char'){
      frameOffset = frameOffset;
      return new Int8Array(buffer, frameOffset, numPixels);
    }
    else if(this._dataSet.type === 'uint8'){
      frameOffset = frameOffset;
      return new Uint8Array(buffer, frameOffset, numPixels);
    }
    else if(this._dataSet.type === 'int16' ||
       this._dataSet.type === 'short'){
      frameOffset = frameOffset * 2;
      return new Int16Array(buffer, frameOffset, numPixels);
    }
    else if(this._dataSet.type === 'uint16'){
      frameOffset = frameOffset * 2;
      return new Uint16Array(buffer, frameOffset, numPixels);
    }
    else if(this._dataSet.type === 'int32'){
      frameOffset = frameOffset * 4;
      return new Int32Array(buffer, frameOffset, numPixels);
    }
    else if(this._dataSet.type === 'uint32' ){
      frameOffset = frameOffset * 4;
      return new Uint32Array(buffer, frameOffset, numPixels);
    }
    else if(this._dataSet.type === 'float'){
      frameOffset = frameOffset * 4;
      return new Float32Array(buffer, frameOffset, numPixels);
    }

  }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-cameras.html">cameras</a></li><li><a href="module-cameras_orthographic.html">cameras/orthographic</a></li><li><a href="module-core.html">core</a></li><li><a href="module-core_intersections.html">core/intersections</a></li><li><a href="module-core_pack.html">core/pack</a></li><li><a href="module-core_utils.html">core/utils</a></li><li><a href="module-core_validators.html">core/validators</a></li><li><a href="module-geometries.html">geometries</a></li><li><a href="module-geometries_slice.html">geometries/slice</a></li><li><a href="module-geometries_voxel.html">geometries/voxel</a></li><li><a href="module-helpers.html">helpers</a></li><li><a href="module-helpers_border.html">helpers/border</a></li><li><a href="module-helpers_boundingbox.html">helpers/boundingbox</a></li><li><a href="module-helpers_dummy.html">helpers/dummy</a></li><li><a href="module-helpers_lut.html">helpers/lut</a></li><li><a href="module-helpers_material_mixin.html">helpers/material/mixin</a></li><li><a href="module-helpers_progressBar.html">helpers/progressBar</a></li><li><a href="module-helpers_slice.html">helpers/slice</a></li><li><a href="module-helpers_stack.html">helpers/stack</a></li><li><a href="module-helpers_volumerendering.html">helpers/volumerendering</a></li><li><a href="module-helpers_voxel.html">helpers/voxel</a></li><li><a href="module-loaders.html">loaders</a></li><li><a href="module-loaders_base.html">loaders/base</a></li><li><a href="module-loaders_volumes.html">loaders/volumes</a></li><li><a href="module-models.html">models</a></li><li><a href="module-models_base.html">models/base</a></li><li><a href="module-models_frame.html">models/frame</a></li><li><a href="module-models_series.html">models/series</a></li><li><a href="module-models_stack.html">models/stack</a></li><li><a href="module-models_voxel.html">models/voxel</a></li><li><a href="module-parsers.html">parsers</a></li><li><a href="module-parsers_dicom.html">parsers/dicom</a></li><li><a href="module-parsers_nifti.html">parsers/nifti</a></li><li><a href="module-parsers_volume.html">parsers/volume</a></li><li><a href="module-shaders.html">shaders</a></li><li><a href="module-shaders_data.html">shaders/data</a></li><li><a href="module-widgets.html">widgets</a></li><li><a href="module-widgets_handle.html">widgets/handle</a></li><li><a href="module-widgets_squareProbe.html">widgets/squareProbe</a></li><li><a href="module-widgets_voxelProbe.html">widgets/voxelProbe</a></li></ul><h3>Classes</h3><ul><li><a href="module.exports.html">exports</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.0-dev</a> on Wed Nov 23 2016 10:31:28 GMT+0100 (CET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
